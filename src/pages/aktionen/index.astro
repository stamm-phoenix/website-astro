---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import aktionenData from '../../data/aktionen.json';

export type IcsEvent = {
    uid?: string;
    start?: Date;
    end?: Date;
    allDay?: boolean;
    summary?: string;
    location?: string;
    description?: string;
    url?: string;
};

const GROUPS = {
    alle: '',
    woelflinge: 'ðŸŸ ',
    jupfis: 'ðŸ”µ',
    pfadis: 'ðŸŸ¢',
    rover: 'ðŸ”´',
} as const;

/* -------------------------
   Fetch and prepare events
   ------------------------- */
let events: IcsEvent[] = aktionenData.map(event => ({
    ...event,
    start: event.start ? new Date(event.start as string) : undefined,
    end: event.end ? new Date(event.end as string) : undefined,
})) as IcsEvent[];

// Only upcoming (or ongoing) events
const now = new Date();
const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
events = events.filter((e) => {
    const end = e.end ?? e.start!;
    return end >= todayMidnight;
});

// Sort by start date ascending
events.sort((a, b) => (a.start!.getTime() - b.start!.getTime()));

const dfDate = new Intl.DateTimeFormat('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
const dfTime = new Intl.DateTimeFormat('de-DE', { hour: '2-digit', minute: '2-digit' });

function formatWhen(e: IcsEvent): string {
    const s = e.start!;
    const eEnd = e.end;
    if (e.allDay) {
        if (eEnd && eEnd.getTime() - s.getTime() > 24 * 3600 * 1000) {
            const inclusiveEnd = new Date(eEnd.getTime() - 1);
            return `${dfDate.format(s)} â€“ ${dfDate.format(inclusiveEnd)}`;
        }
        return `${dfDate.format(s)} (ganztÃ¤gig)`;
    }
    if (eEnd) {
        const sameDay =
            s.getFullYear() === eEnd.getFullYear() &&
            s.getMonth() === eEnd.getMonth() &&
            s.getDate() === eEnd.getDate();
        if (sameDay) {
            return `${dfDate.format(s)}, ${dfTime.format(s)}â€“${dfTime.format(eEnd)}`;
        }
        return `${dfDate.format(s)}, ${dfTime.format(s)} â€“ ${dfDate.format(eEnd)}, ${dfTime.format(eEnd)}`;
    }
    return `${dfDate.format(s)}, ${dfTime.format(s)}`;
}
---

<BaseLayout title="Kalender | Stamm Phoenix" description="Termine und Aktionen des DPSG Stamm Phoenix.">
    <Header slot="header" />

    <section class="prose">
        <h1>Kalender</h1>
        <p>Hier finden Sie kommende Aktionen und Termine unseres Stammes.</p>
        <p class="text-sm">
            iCal/ICS abonnieren:
            <a class="underline" href={ICS_URL} rel="nofollow">Kalender-Link</a>
        </p>

        {/* Filter UI */}
        <div class="mt-4 flex flex-wrap gap-2 text-sm" id="filter-buttons">
            {Object.entries(GROUPS).map(([key, emoji]) => {
                const label =
                    key === 'alle' ? 'Alle' :
                    key === 'woelflinge' ? `${emoji} WÃ¶lflinge` :
                    key === 'jupfis' ? `${emoji} Jungpfadfinder` :
                    key === 'pfadis' ? `${emoji} Pfadfinder` :
                    `${emoji} Rover`;

                return (
                    <button
                        type="button"
                        data-group={key}
                        class="filter-btn inline-flex items-center rounded-md border border-[var(--color-neutral-200)] bg-white px-3 py-1 text-[var(--color-neutral-800)] hover:bg-[var(--color-neutral-50)] transition duration-75 aria-pressed:border-brand-500 aria-pressed:bg-brand-50 aria-pressed:text-brand-700"
                        aria-pressed={key === 'alle' ? 'true' : 'false'}
                    >
                        {label}
                    </button>
                );
            })}
        </div>
    </section>

    {events.length ? (
        <ul class="mt-6 grid gap-6 md:grid-cols-2" id="events-list">
            {events.map((ev) => {
                // Determine groups for this event
                let groups = [];
                if (ev.summary?.includes('ðŸŸ ')) groups.push('woelflinge');
                if (ev.summary?.includes('ðŸ”µ')) groups.push('jupfis');
                if (ev.summary?.includes('ðŸŸ¢')) groups.push('pfadis');
                if (ev.summary?.includes('ðŸ”´')) groups.push('rover');
                // If no specific emoji, it might be for all, or we can just not assign a group class
                // But usually we want to show it for 'alle'. 
                // We will add data attributes for filtering.
                
                const groupData = groups.join(' ');

                return (
                <li 
                    class="event-item rounded-[var(--radius-lg)] border border-[var(--color-neutral-200)] bg-white p-5 shadow-[var(--shadow-soft)] hover:shadow-md transition"
                    data-groups={groupData}
                >
                    <div class="flex flex-col gap-2">
                        <h3 class="text-lg font-semibold text-[var(--color-neutral-900)]">
                            {ev.summary?.replace(/[ðŸŸ ðŸ”µðŸŸ¢ðŸ”´]/g, '') || 'Termin'}
                        </h3>
                        <div class="text-sm text-[var(--color-neutral-700)]">
                            {formatWhen(ev)}
                        </div>
                        {ev.location && (
                            <div class="text-sm text-[var(--color-neutral-700)]">
                                Ort: {ev.location}
                            </div>
                        )}
                        {ev.summary && ['ðŸŸ ', 'ðŸ”µ', 'ðŸŸ¢', 'ðŸ”´'].some((emoji) => ev.summary?.includes(emoji)) && (
                            <p class="text-sm text-[var(--color-neutral-700)] whitespace-pre-line">
                                {ev.summary?.includes('ðŸŸ ') && 'ðŸŸ  WÃ¶lflinge\n'}
                                {ev.summary?.includes('ðŸ”µ') && 'ðŸ”µ Jungpfadfinder\n'}
                                {ev.summary?.includes('ðŸŸ¢') && 'ðŸŸ¢ Pfadfinder\n'}
                                {ev.summary?.includes('ðŸ”´') && 'ðŸ”´ Rover\n'}
                            </p>
                        )}
                        <div class="pt-1">
                            <a 
                                href={`/aktionen/${ev.uid}`} 
                                class="inline-flex items-center text-sm underline text-brand-600 hover:text-brand-500">
                                Mehr Infos
                            </a>
                        </div>
                    </div>
                </li>
            )})}
        </ul>
    ) : (
        <p class="mt-6 rounded-[var(--radius-md)] border border-[var(--color-neutral-200)] bg-white p-4 shadow-[var(--shadow-soft)]">
            Aktuell sind keine bevorstehenden Termine vorhanden.
        </p>
    )}

    <Footer slot="footer" />

    <script>
        const buttons = document.querySelectorAll('.filter-btn');
        const events = document.querySelectorAll('.event-item');

        function filterEvents(group) {
            // Update buttons
            buttons.forEach(btn => {
                const isPressed = btn.getAttribute('data-group') === group;
                btn.setAttribute('aria-pressed', isPressed.toString());
            });

            // Filter events
            events.forEach(ev => {
                const groups = (ev as HTMLElement).dataset.groups || '';
                if (group === 'alle' || groups.includes(group)) {
                    (ev as HTMLElement).style.display = '';
                } else {
                    (ev as HTMLElement).style.display = 'none';
                }
            });
        }

        // Initialize from URL param if present
        const params = new URLSearchParams(window.location.search);
        const initialGroup = params.get('gruppe') || 'alle';
        filterEvents(initialGroup);

        // Add click handlers
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const group = btn.getAttribute('data-group') || 'alle';
                filterEvents(group);
                
                // Update URL without reload
                const newUrl = new URL(window.location.href);
                if (group === 'alle') {
                    newUrl.searchParams.delete('gruppe');
                } else {
                    newUrl.searchParams.set('gruppe', group);
                }
                window.history.pushState({}, '', newUrl);
            });
        });
    </script>
</BaseLayout>