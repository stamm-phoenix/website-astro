---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import aktionenData from '../../data/aktionen.json';
import {
    extractGroups,
    formatEventDate,
    GROUP_EMOJIS,
    GROUP_LABELS,
    isUpcoming,
    normalizeEvents,
    stripGroupEmojis,
} from '../../lib/events';
import type { GroupKey } from '../../lib/events';

const GROUP_FILTERS = [
    { key: 'alle', label: 'Alle' },
    ...(Object.entries(GROUP_LABELS) as [GroupKey, string][]).map(([key, label]) => ({
        key,
        label: `${GROUP_EMOJIS[key]} ${label}`,
    })),
];

const parsedEvents = normalizeEvents(aktionenData);
const upcomingEvents = parsedEvents
    .filter((event) => isUpcoming(event))
    .sort((a, b) => a.start.getTime() - b.start.getTime());

const ICS_URL = '';
---

<BaseLayout title="Kalender | Stamm Phoenix" description="Termine und Aktionen des DPSG Stamm Phoenix.">
    <Header slot="header" />

    <section class="prose">
        <h1>Kalender</h1>
        <p>Hier finden Sie kommende Aktionen und Termine unseres Stammes.</p>
        {ICS_URL && (
            <p class="text-sm">
                iCal/ICS abonnieren:
                <a class="underline" href={ICS_URL} rel="nofollow">Kalender-Link</a>
            </p>
        )}

        {/* Filter UI */}
        <div class="mt-4 flex flex-wrap gap-2 text-sm" id="filter-buttons">
            {GROUP_FILTERS.map((group) => (
                <button
                    type="button"
                    data-group={group.key}
                    class="filter-btn inline-flex items-center rounded-sm border border-[var(--color-neutral-200)] bg-white px-3 py-1 text-[var(--color-neutral-800)] hover:border-[var(--color-brand-700)] hover:text-brand-900 transition duration-75 aria-pressed:border-[var(--color-accent-500)] aria-pressed:bg-[var(--color-brand-50)] aria-pressed:text-brand-900"
                    aria-pressed={group.key === 'alle' ? 'true' : 'false'}
                >
                    {group.label}
                </button>
            ))}
        </div>
    </section>

    {upcomingEvents.length ? (
        <ul class="mt-6 grid gap-6 md:grid-cols-2" id="events-list">
            {upcomingEvents.map((event) => {
                const groups = extractGroups(event.summary);
                const groupData = groups.join(' ');
                const groupLabel = groups
                    .map((group) => `${GROUP_EMOJIS[group]} ${GROUP_LABELS[group]}`)
                    .join('\n');
                const title = stripGroupEmojis(event.summary ?? 'Termin') || 'Termin';

                return (
                <li
                    class="event-item rounded-[var(--radius-md)] border border-[var(--color-neutral-200)] bg-white p-5 shadow-soft border-l-4 border-[var(--color-accent-500)]"
                    data-groups={groupData}
                >
                    <div class="flex flex-col gap-2">
                        <h3 class="text-lg font-semibold text-brand-900">
                            {title}
                        </h3>
                        <div class="text-sm text-[var(--color-neutral-700)]">
                            {formatEventDate(event)}
                        </div>
                        {event.location && (
                            <div class="text-sm text-[var(--color-neutral-700)]">
                                Ort: {event.location}
                            </div>
                        )}
                        {groupLabel && (
                            <p class="text-sm text-[var(--color-neutral-700)] whitespace-pre-line">
                                {groupLabel}
                            </p>
                        )}
                        {event.description && (
                            <p class="text-sm text-[var(--color-neutral-700)]">
                                {event.description}
                            </p>
                        )}
                        <div class="pt-1 flex gap-3">
                            {event.url && (
                                <a
                                    href={event.url}
                                    class="inline-flex items-center text-sm underline text-brand-800 hover:text-brand-900 font-semibold"
                                    rel="noopener"
                                >
                                    Externe Infos
                                </a>
                            )}
                            <a 
                                href={`/aktionen/${event.uid}`} 
                                class="inline-flex items-center text-sm underline text-brand-800 hover:text-brand-900 font-semibold">
                                Mehr Infos
                            </a>
                        </div>
                    </div>
                </li>
            )})}
        </ul>
    ) : (
        <p class="mt-6 rounded-[var(--radius-md)] border border-[var(--color-neutral-200)] bg-white p-4 shadow-[var(--shadow-soft)]">
            Aktuell sind keine bevorstehenden Termine vorhanden.
        </p>
    )}

    <Footer slot="footer" />

    <script>
        const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
        const eventCards = Array.from(document.querySelectorAll('.event-item'));

        const setFilter = (group) => {
            filterButtons.forEach((btn) => {
                btn.setAttribute('aria-pressed', btn.dataset.group === group ? 'true' : 'false');
            });

            eventCards.forEach((card) => {
                const groups = (card.dataset.groups || '')
                    .split(' ')
                    .map((value) => value.trim())
                    .filter(Boolean);
                const isVisible = group === 'alle' || groups.includes(group);
                card.classList.toggle('hidden', !isVisible);
            });
        };

        const params = new URLSearchParams(window.location.search);
        setFilter(params.get('gruppe') || 'alle');

        filterButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const group = btn.dataset.group || 'alle';
                setFilter(group);

                const newUrl = new URL(window.location.href);
                if (group === 'alle') {
                    newUrl.searchParams.delete('gruppe');
                } else {
                    newUrl.searchParams.set('gruppe', group);
                }
                window.history.replaceState({}, '', newUrl);
            });
        });
    </script>
</BaseLayout>
